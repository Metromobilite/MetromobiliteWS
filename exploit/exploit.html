<!doctype html>
<!--
// Metromobilité is the mobile application of Grenoble Alpes Métropole <http://www.metromobilite.fr/>.
// It provides all the information and services for your travels in Grenoble agglomeration.

// Copyright (C) 2013
// Contributors:
//	NB/VT - sully-group - www.sully-group.fr - initialisation and implementation

// This program is free software: you can redistribute it and/or modify
// it under the terms of the GNU Affero General Public License as
// published by the Free Software Foundation, either version 3 of the
// License, or (at your option) any later version.

// This program is distributed in the hope that it will be useful,
// but WITHOUT ANY WARRANTY; without even the implied warranty of
// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
// GNU Affero General Public License for more details.

// You should have received a copy of the GNU Affero General Public License
// along with this program.  If not, see <http://www.gnu.org/licenses/>.
-->
<html lang="fr">
	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta content="initial-scale=1.0, user-scalable=no, width=device-width" name="viewport">
		<title>Exploitation</title>
		<link href="lib/css/bootstrap.min.css" rel="stylesheet">
		<link href="lib/css/bootstrap-datetimepicker.min.css" rel="stylesheet">
		<link href="lib/ol.css" rel="stylesheet">
		<style type='text/css'>
			#nsvligne .nsv {height:20px;margin:2px;}
			#nsvligne .nsv[data-nsv="1"] {background-color:#77E040;}
			#nsvligne .nsv[data-nsv="2"] {background-color:rgba(255, 171, 0, 0.83);}
			#nsvligne .nsv[data-nsv="3"] {background-color:rgba(255, 36, 0, 0.81);}
			#nsvligne .nsv[data-nsv="4"] {background-color:#000;}
			#nsvligne .nsv[data-nsv="5"] {background-color:#777;}
			#nsvPAR .nsv {height:20px;margin:2px;}
			#nsvPAR .nsv[data-nsv="1"] {background-color:#77E040;}
			#nsvPAR .nsv[data-nsv="2"] {background-color:rgba(255, 171, 0, 0.83);}
			#nsvPAR .nsv[data-nsv="3"] {background-color:rgba(255, 36, 0, 0.81);}
			#nsvPKG .nsv {height:20px;margin:2px;}
			#nsvPKG .nsv[data-nsv="1"] {background-color:#77E040;}
			#nsvPKG .nsv[data-nsv="2"] {background-color:rgba(255, 171, 0, 0.83);}
			#nsvPKG .nsv[data-nsv="3"] {background-color:rgba(255, 36, 0, 0.81);}
			#nsvPMV .nsv {
				background-color: #000;
				color: #c6c15e;
				font-family: "courier new",courier,monospace;
				font-size: 9px;
				margin: 2px;
				max-width: 12em;
			}
			#nsvPMV .nsv hr{
				margin:0px;
			}
			#evt, #PME {height:700px;overflow-y:auto;}
			#evt .evt td,#PME .PME td {
				background-color: #c0c0c0;
				border-color: #fff;
				border-style: solid;
				border-width: 1px;
				font-family: Tahoma;
				font-size: 12px;
				padding: 2px 5px;
			}
			#evt .evt:hover td, #evt .evt:focus td,#PME .PME:hover td, #PME .PME:focus td {
				background-color: #e0e0e0;
			}
			#evt .evtCommentaire {
				display:none;
				background-color: #e0e0e0;
				border-color: #fff;
				border-style: solid;
				border-width: 1px;
				font-family: Tahoma;
				font-size: 12px;
				padding: 2px 5px;
			}
			#evt tr.evt:focus + tr > td.evtCommentaire {
				display:table-cell;
			}
			#indiceTr,#indiceTc,#indiceAtmo {margin: 10px 0px;}
			#map { width:100%; height:700px; }
			code { display:none }
			#SEMGTFSActif { width:225px; }
			/*#tabEtats div { padding-top:5px; }*/
		</style>
	</head>
	<body>
		<div class="col-xs-6">
			<div>
				<nav class="navbar navbar-default">
					<div class="container-fluid">
						<div class="navbar-header">
						  <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navDataRT" aria-expanded="false">
							<span class="sr-only">Toggle navigation</span>
							<span class="icon-bar"></span>
							<span class="icon-bar"></span>
							<span class="icon-bar"></span>
						  </button>
						  <a class="navbar-brand" href="#" id="statut">Déconnecté !</a>
						</div>
						<div class="collapse navbar-collapse" id="navDataRT">
							<ul class="nav navbar-nav" role="tablist">
								<li role="presentation" class="active"><a href="#tabEvt" aria-controls="tabEvt" role="tab" data-toggle="tab">Evenements<span class="sr-only">(current)</span></a></li>
								<li role="presentation"><a href="#tabEtats" aria-controls="tabEtats" role="tab" data-toggle="tab">Etats</a></li>
								<li role="presentation"><a href="#tabPMV" aria-controls="tabPMV" role="tab" data-toggle="tab">PMV</a></li>
								<li role="presentation"><a href="#tabPAR" aria-controls="tabPAR" role="tab" data-toggle="tab">P+R</a></li>
								<li role="presentation"><a href="#tabPKG" aria-controls="tabPKG" role="tab" data-toggle="tab">Parkings</a></li>
								<li role="presentation"><a href="#tabligne" aria-controls="tabligne" role="tab" data-toggle="tab">Lignes</a></li>
								<li role="presentation"><a href="#tabPME" aria-controls="tabPME" role="tab" data-toggle="tab">PME</a></li>
								<li role="presentation"><a href="#tabindice" aria-controls="tabindice" role="tab" data-toggle="tab">indices</a></li>
							</ul>
						</div>
					</div>
				</nav>
			</div>
			<div class="tab-content">
				<div role="tabpanel" class="tab-pane active" id="tabEvt">
					<div id="evt" class="container-fluid">
						<table class="col-xs-12">
							<caption>Evenements</caption>
							<thead>
								<th></th>
								<th>
									<select id="filtreCodeEvt">
										<option value="code">Partenaire</option>
										<option value="SEM">TAG</option>
										<option value="DDE">DIR</option>
										<option value="GAM">La Metro</option>
										<option value="GRE">Grenoble</option>
									</select>
								</th>
								<th>
									<select id="filtreTypeEvt">
										<option value="type">type</option>
										<option value="restriction_ltc">TC</option>
										<option value="restriction_par">Parking</option>
										<option value="chantier">chantier</option>
										<option value="bouchon">bouchon</option>
										<option value="panne">panne</option>
										<option value="accident">accident</option>
										<option value="manifestation">manifestation</option>
										<option value="restriction">restriction</option>
										<option value="obstacle">obstacle</option>
									</select>
								</th>
								<th>debut</th>
								<th>fin</th>
								<th>heure debut</th>
								<th>heure fin</th>
							</thead>
							<tbody></tbody>
						</table>
					</div>
					<code id="ioEvt"></code>
					<code id="iotrr"></code>
				</div>
				<div role="tabpanel" class="tab-pane" id="tabEtats">
					<div class="panel panel-default">
						<div class="panel-heading">Liaisons serveurs</div>
						<div id="nsvLiaisonsServeurs" class="panel-body"></div>
					</div>
					<div class="panel panel-default">
						<div class="panel-heading">GTFS-RT</div>
						<div id="nsvEtats" class="panel-body">
							<div class="" id='dataGTFS-RT'></div>
							<div><a id="SEMGTFSActif" class="btn btn-default" href="#" role="button">GTFS-RT SEM</a></div>
						</div>
					</div>
					<div><a id="debug" class="btn btn-default" href="#" role="button">Debug</a></div>
					<div><a id="forceTotemAtmo" class="btn btn-default" href="#" role="button">-1</a></div>
					
				</div>
				<div role="tabpanel" class="tab-pane" id="tabPMV">
					<div id="nsvPMV" class="container-fluid"></div>
					<code id="ioPMV"></code>
				</div>
				<div role="tabpanel" class="tab-pane" id="tabPAR">
					<div id="nsvPAR" class="container-fluid"></div>
					<code id="ioPAR"></code>
				</div>
				<div role="tabpanel" class="tab-pane" id="tabPKG">
					<div id="nsvPKG" class="container-fluid"></div>
					<code id="ioPKG"></code>
				</div>
				<div role="tabpanel" class="tab-pane" id="tabligne">
					<div id="nsvligne" class="container-fluid"></div>
					<code id="ioligne"></code>
				</div>
				<div role="tabpanel" class="tab-pane" id="tabPME">
					<div id="PME" class="container-fluid">
						<table>
						<caption>PME</caption>
							<thead>
								<th></th>
								<th>
									<select id="filtreCodePME">
										<option value="code">Code</option>
										<option value="DDE">DIR</option>
										<option value="GRE">La Metro</option>
										<option value="ARE">Area</option>
									</select>
								</th>
								<th>Q</th>
								<th>T</th>
								<th>V</th>
							</thead>
							<tbody></tbody>
						</table>
					</div>
					<code id="ioPME"></code>
				</div>
				<div role="tabpanel" class="tab-pane" id="tabindice">
					<div id="nsvligne" class="container-fluid">
						<div id="indiceTc" class="row"></div>
						<div id="indiceTr" class="row"></div>
						<div id="indiceAtmoFull" class="row">
							<h3 class="col-xs-12">indiceAtmoFull</h3>
							<div class="col-xs-12">Le : <span class="date"></span></div>
							<div class="col-xs-12">indice_exposition_sensible : <span class="indice_exposition_sensible"></span></div>
							<div class="col-xs-12">polluant_majoritaire : <span class="polluant_majoritaire"></span></div>
							<div class="col-xs-12">tendance_apres_demain : <span class="tendance_apres_demain"></span></div>
							<div class="col-xs-12">dispositif_en_cours : <span class="dispositif_en_cours"></span></div>
							<div class="col-xs-12">commentaire : <span class="commentaire"></span></div>
							<div class="col-xs-12">activation : <span class="activation"></span></div>
							<div class="col-xs-12">action lendemain : <span class="action"></span></div>
						</div>						

						<code id="ioindiceTc"></code>
						<code id="ioindiceTr"></code>
						<code id="ioindiceAtmo"></code>
						<code id="ioindiceAtmoFull"></code>
					</div>
				</div>
			</div>
		</div>
		<div class="col-xs-6">
			<div id="map">
		</div>

		<script type="text/javascript" src="lib/jquery-2.1.1.min.js"></script>
		<script type="text/javascript" src="lib/ol.js"></script>
		<script type="text/javascript" src="lib/js/moment-with-locales.min.js"></script>
		<script type="text/javascript" src="lib/js/bootstrap.min.js"></script>
		<script type="text/javascript" src="lib/js/bootstrap-datetimepicker.min.js"></script>
		<script type="text/javascript" src="js/outils.js"></script>
		<script type="text/javascript" src="js/carte.js"></script>
		<script type="text/javascript" src="js/fr.js"></script>
		<script type="text/javascript" src="/socket.io/socket.io.js"></script>
		<script type="text/javascript" src="exploit.js"></script>
		<script>
			var map = initCarte();
			chargeLignes(function(){},function(){});
			$( document ).on( "evtLignesChargees", {}, function( event, data ) {
				for (var d in data) {
					$('#nsvligne').append('<div id="'+d+'" class="row"><div class="col-xs-2">'+d+'</div><div class="listensv"><div></div>');
				}
				tri('#nsvligne','div.row','','id');
			});
				
			$('#evt tbody').on('click','.evt:not([data-typeEvt=restriction_ltc])',function(e){
				var id = $(this).attr('data-codeEvt');
				var f = sourceEvtTr.getFeatureById(id);
				map.getView().setCenter(f.getGeometry().getCoordinates());
				map.getView().setZoom(16);
			});
			$('#filtreTypeEvt').on('change',filtreEvt);
			$('#filtreCodeEvt').on('change',filtreEvt);
			function filtreEvt(e){
				var v = $('#filtreTypeEvt').val();
				filtreTypeEvt = v;
				$('#evt tbody .evt').show();
				if (v!='type') {
					$('#evt tbody .evt:not([data-typeEvt = "'+v+'"])').hide();
				}
				v = $('#filtreCodeEvt').val();
				filtreCodeEvt = v;
				if (v!='code') {
					$('#evt tbody .evt:not([data-codeEvt ^= "'+v+'"])').hide();
				}
				sourceEvtTr.changed();
			}
			$('#PME tbody').on('click','.PME',function(e){
				var id = $(this).attr('data-codePME');
				var f = sourcePoints.getFeatureById(id);
				map.getView().setCenter(f.getGeometry().getCoordinates());
				map.getView().setZoom(16);
			});
			$('#filtreCodePME').on('change',filtrePME);
			function filtrePME(e){
				v = $('#filtreCodePME').val();
				filtreCodePME = v;
				$('#PME tbody .PME').show();
				if (v!='code') {
					$('#PME tbody .PME:not([data-codePME ^= "'+v+'"])').hide();
				}
				sourcePoints.changed();
			}
			map.on('singleclick', function(evt) {
				try{
					map.forEachFeatureAtPixel(evt.pixel, function(f){
						$('#PME tbody .PME[data-codePME = "'+f.getId()+'"]').focus();
						$('#evt tbody .evt[data-codeEvt = "'+f.getId()+'"]').focus();
					});
				return false;
				} catch(e){
					console.log(e.msg+' : '+e.lineNumber);
				}
			});
			function updateGTFSbutton(bActif) {
				if(bActif === true) {
					$('#SEMGTFSActif').text('GTFS-RT SEM ACTIF');
				} else if(bActif === false) {
					$('#SEMGTFSActif').text('GTFS-RT SEM INACTIF');
				}
				else {
					$('#SEMGTFSActif').text('GTFS-RT SEM INCONNU');
				}
			}
			moment.locale('fr');
			function initSocket(){
				var urlServ = location.protocol+'//'+location.hostname+':8087/';
				//var urlServ = 'http://sersiv:8087';
				//var socket = io('http://sersiv:8087/',{'forceNew':true });
				var socket = io(urlServ,{'forceNew':true });
				socket.on('connect', function(){
					$('#statut').text('Connecté !');
					socket.emit('getAll','PMV');
					socket.emit('getAll','PAR');
					socket.emit('getAll','PKG');
					socket.emit('getAll','ligne');
					socket.emit('getAll','trr');
					socket.emit('getAll','trrC38');
					socket.emit('getAll','indiceAtmo');
					socket.emit('getAll','indiceAtmoFull');
					socket.emit('getAll','indiceAtmoFullFake');
					socket.emit('getAll','indiceTc');
					socket.emit('getAll','indiceTr');
					socket.emit('getAll','evt');
					socket.emit('getAll','etatsServeursHoraires');
					socket.emit('getAll','liaisonsServeurs');
					$( document ).on( "evtSourceChargee", {}, function( event, type ) {
						if(type=='PME') {
							socket.emit('getAll','PME');
						}
					});
				});
				socket.on('debug', function(data){
					$('#debug').toggleClass('active',data.bDebug);
				});
				socket.on('SEMGTFSActif', function(data){
					$('#SEMGTFSActif').toggleClass('active',data.bActif);
					updateGTFSbutton(data.bActif);
				});
				socket.on('forceTotemAtmo', function(data){
					$('#forceTotemAtmo').attr('data-force-value',data.forceValue);
					$('#forceTotemAtmo').text('Forçage totem à : '+data.forceValue);
				});
				socket.on('disconnect', function(){ $('#statut').text('Déconnecté !'); });
				socket.on('updatePMV', function(data){
					for(var d in data) {
						if($('#'+d).length==0) {
							$('#nsvPMV').append('<div id="'+d+'" class="row"><div class="col-xs-12">'+d+'</div><div class="listensv"><div></div>');
						}
						$('#'+d+' .listensv').html('');
						for (var i=0;i<data[d].length;i++){
							var message = data[d][i].messages.replace(/\|/g,'<br/>').replace(/\ /g,'&nbsp;').replace(/\$/g,'<hr/>');
							var sDelai = moment(data[d][i].time).fromNow();
							$('#'+d+' .listensv').append('<div class="nsv col-xs-2" title="'+sDelai+'">'+message+'</div>');
						}
					}
				});
				socket.on('updateligne', function(data){
					for(var d in data) {
						if($('#'+d).length==0) {
							$('#nsvligne').append('<div id="'+d+'" class="row"><div class="col-xs-2">'+d+'</div><div class="listensv"><div></div>');
						}
						$('#'+d+' .listensv').html('');
						for (var i=0;i<data[d].length;i++){
							var nsv = data[d][i].nsv_id;
							var sDelai = moment(data[d][i].time).fromNow();
							$('#'+d+' .listensv').append('<div class="nsv col-xs-1" data-nsv="'+nsv+'" title="'+sDelai+'"></div>');
						}
					}
				});
				socket.on('updatetrr', function(data){
					urlParams.heure = new Date();
					parseDyn('trr',sourceTrr,data);
				});
				socket.on('updatetrrC38', function(data){
					urlParams.heure = new Date();
					parseDyn('trrC38',sourceTrr,data);
				});
				socket.on('updatePME', function(data){
					urlParams.heure = new Date();
					$('#PME tbody').html('');
					for(var d in data) {
						var last=data[d][data[d].length-1];
						if (last.Q != -1) {
							$('#PME tbody').append('<tr class="PME row" tabindex="0" title="'+new Date(last.time).toLocaleString()+'" data-codePME="'+d+'"><td class="">'+d+'</td><td class="">'+last.Q+'</td><td class="">'+last.T+'</td><td class="">'+last.V+'</td></tr>');
						}					}
					parseDyn('PME',sourcePoints,data);
					filtrePME();
				});
				socket.on('updateindiceAtmoFull', function(data){
					parseAtmoFull(data, 'indiceAtmoFull');
				});

				socket.on('updateindiceTr', function(data){
					for(var d in data) {
						for (var i=0;i<data[d].length;i++){
							$('#indiceTr').html('Indice Routier : '+data[d][i].indice);
						}
					}
				});
				socket.on('updateindiceTc', function(data){
					for(var d in data) {
						for (var i=0;i<data[d].length;i++){
							$('#indiceTc').html('Indice TC : '+data[d][i].indice);
						}
					}
				});
				socket.on('updatePAR', function(data){
					for(var d in data) {
						if($('#'+d).length==0) {
							$('#nsvPAR').append('<div id="'+d+'" class="row"><div class="col-xs-2">'+d+'</div><div class="listensv"><div></div>');
						}
						$('#'+d+' .listensv').html('');

						for (var i=0;i<data[d].length;i++){
							var nsv = data[d][i].nsv_id;
							var sDelai = moment(data[d][i].time).fromNow();
							$('#'+d+' .listensv').append('<div class="nsv col-xs-1" data-nsv="'+nsv+'" title="'+sDelai+'">'+data[d][i].dispo+'</div>');
						}
					}
				});
				socket.on('updatePKG', function(data){
					for(var d in data) {
						if($('#'+d).length==0) {
							$('#nsvPKG').append('<div id="'+d+'" class="row"><div class="col-xs-2">'+d+'</div><div class="listensv"><div></div>');
						}
						$('#'+d+' .listensv').html('');

						for (var i=0;i<data[d].length;i++){
							var nsv = data[d][i].nsv_id;
							var sDelai = moment(data[d][i].time).fromNow();
							$('#'+d+' .listensv').append('<div class="nsv col-xs-1" data-nsv="'+nsv+'" title="'+sDelai+'">'+data[d][i].dispo+'</div>');
						}
					}
				});
				socket.on('updateevt', function(data){
					$('#evt tbody').html('');
					for(var d in data) {
						$('#evt tbody').append('<tr class="evt row" tabindex="0" data-typeEvt="'+data[d].type+'" data-codeEvt="'+d+'"><td class="">'+d+'</td><td class="">'+data[d].type+'</td><td class="">'+data[d].dateDebut+'</td><td class="">'+data[d].dateFin+'</td><td class="">'+data[d].heureDebut+'</td><td class="">'+data[d].heureFin+'</td></tr><tr><td  colspan="7" class="evtCommentaire">'+data[d].texte.replace(/\|/g,'<br/>')+'</td></tr>');
						for (var d in evtCache) {
							evtCache[d].remove = true;
						}
						for (d in data) {
							parseEvtTr(d,data[d],sourceEvtTr,{});
							evtCache[d]={remove:false};
						}
						for (var d in evtCache) {
							if(evtCache[d].remove) {
								sourceEvtTr.removeFeature(sourceEvtTr.getFeatureById(d));
								delete evtCache[d];
							}
						}
					}
					filtreEvt();
				});
				socket.on('updateetatsServeursHoraires',function(data){
					/*var nbLignesRT=0;
					for (var l in data.realTimeOTP) {
						if(!!data.realTimeOTP[l]) nbLignesRT++;
					}
					$('#dataOTP').text('OTP : '+ (data.OTP?'actif':'inactif') +', avec '+nbLignesRT+' lignes en temps réel requétées récemment');
					$('#dataSEM').text('SEM : '+(data.SEM?'actif':'inactif'));
					$('#dataSEMGTFS').text('GTFS SEM : '+(data.SEMGTFS?'actif':'inactif') +(data.lastTestSEMGTFS?', derniere tentative : ' +  moment(data.lastTestSEMGTFS).fromNow():''));
					$('#dataC38').text('C38 : '+(data.C38?'actif':'inactif'));
					$('#SEMGTFSStatus').prop('checked', data.SEM && data.SEMGTFS);*/
					
				});
				socket.on('updateetatGtfsRt',function(data){
					var nbLignesRT=0;
					for (var l in data.routes) {
						if(!!data.routes[l]) nbLignesRT++;
					}
					var r = Object.keys(data.routes).sort().join(',').replace(/SEM\:/g,'');
					$('#dataGTFS-RT').text('Lignes en temps réel : '+Object.keys(data.routes).sort().join(',').replace(/SEM\:/g,''));
					
				});
				socket.on('updateliaisonsServeurs',function(data){
					var contenu ='';
					for (var serveur in data.etat){
						contenu += '<div class="row'+serveur+'">'+data.etat[serveur].libelle+' : '+data.etat[serveur].lifecycle+'</div>';
					}
					
					$('#nsvLiaisonsServeurs').html(contenu);
				})
				return socket;
			}
			var socket = initSocket();
			$('#debug').click(function(){
				var button = $('#debug').toggleClass('active');
				socket.emit('setDebug',button.hasClass('active'));
				
				$('code').toggle(button.hasClass('active'));
			});
			$('#forceTotemAtmo').click(function(){
				var val = $('#forceTotemAtmo').attr('data-force-value');
				val++;
				if(val > 4) val = -1;
				socket.emit('setForceTotemAtmo',val);
			});

			$('#SEMGTFSActif').click(function(){
				var button = $('#SEMGTFSActif').toggleClass('active');
				socket.emit('setSEMGTFSActif',button.hasClass('active'));
				
				$('code').toggle(button.hasClass('active'));
				
				updateGTFSbutton(button.hasClass('active'));
			});
			$('#navDataRT a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
				switch(e.target.attributes.href.value.substr(4)) {
					case 'indice':
						layerAtmo.set('visible',true);
						break;
					case 'PME':
						layerPME.set('visible',true);
						break;
					case 'Evt':
						layerEvtTr.set('visible',true);
						layerTrr.set('visible',true);
						layerTrrC38.set('visible',true);
						break;
					default:
				}
				switch(e.relatedTarget.attributes.href.value.substr(4)) {
					case 'indice':
						layerAtmo.set('visible',false);
						break;
					case 'PME':
						layerPME.set('visible',false);
						break;
					case 'Evt':
						layerEvtTr.set('visible',false);
						layerTrr.set('visible',false);
						layerTrrC38.set('visible',false);
						break;
					default:
				}
			});
			
		</script>
	</body>
</html>